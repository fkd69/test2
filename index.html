<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>温度と湿度のグラフ（スライダー付き）</title>
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script> <!-- CanvasJSライブラリ -->
</head>
<body>

    <div id="chartContainer" style="width: 80%; height: 500px; margin: auto;"></div>

    <!-- 🔹 スライダー（範囲選択用） -->
    <input type="range" id="rangeSlider" min="0" max="30" value="30" step="1" style="width: 80%; margin: 20px auto; display: block;">

    <script>
        // 🔹 Googleスプレッドシートの公開CSV URL
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSY5A0PUveMgm9IHMFKvtNxzb_q1GhZ6pQd5ZIVCeDUUEmi6kpXmcLPrZd3s1VEez-rQzOWdopKBPIl/pub?gid=0&single=true&output=csv';

        let chart; // グラフの変数（スライダー変更時に再描画用）
        let fullData = []; // 全データ保持用（スライダー用）

        // 🔹 CSVデータを取得してグラフに表示
        fetch(sheetUrl)
            .then(response => response.text())
            .then(csvData => {
                const rows = csvData.split("\n").map(row => row.split(",")); // CSVを配列に変換

                // 📌 データの整形
                fullData = {
                    temperature: [],
                    humidity: []
                };

                for (let i = 1; i < rows.length; i++) {  // 1行目（ヘッダー）はスキップ
                    const row = rows[i];

                    // **エラーチェック**
                    if (row.length < 3) continue;  // 空行をスキップ

                    const date = new Date(row[0]);  // 日付（Dateオブジェクトに変換）
                    const temperature = parseFloat(row[1]) || 0;  // 温度データ
                    const humidity = parseFloat(row[2]) || 0;  // 湿度データ

                    fullData.temperature.push({ x: date, y: temperature });
                    fullData.humidity.push({ x: date, y: humidity });
                }

                console.log("温度データ:", fullData.temperature);
                console.log("湿度データ:", fullData.humidity);

                // 🔹 スライダーの最大値をデータ数に合わせる
                document.getElementById("rangeSlider").max = fullData.temperature.length;
                document.getElementById("rangeSlider").value = fullData.temperature.length;

                drawChart(fullData.temperature.length); // 初回表示
            })
            .catch(error => console.error("データ取得エラー:", error));

        // 🔹 グラフを描画する関数（スライダーで更新）
        function drawChart(range) {
            const temperatureData = fullData.temperature.slice(-range);
            const humidityData = fullData.humidity.slice(-range);

            chart = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,  // アニメーション有効
                zoomEnabled: true,       // 🔹 ズーム（スライダー機能）
                panEnabled: true,        // 🔹 パン（ドラッグで移動）
                title: {
                    text: "温度と湿度の推移"
                },
                axisX: {
                    title: "日付",
                    valueFormatString: "YYYY-MM-DD",
                    labelAngle: -50
                },
                axisY: {
                    title: "温度 (℃) / 湿度 (%)"
                },
                data: [
                    {
                        type: "spline",
                        name: "温度 (℃)",
                        showInLegend: true,
                        markerSize: 5,
                        color: "red",
                        dataPoints: temperatureData
                    },
                    {
                        type: "spline",
                        name: "湿度 (%)",
                        showInLegend: true,
                        markerSize: 5,
                        color: "blue",
                        dataPoints: humidityData
                    }
                ]
            });

            chart.render();  // グラフを描画
        }

        // 🔹 スライダーの変更イベント
        document.getElementById("rangeSlider").addEventListener("input", function() {
            const range = parseInt(this.value);
            drawChart(range);
        });

    </script>

</body>
</html>
